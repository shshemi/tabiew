name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: "Dry run (build only, no release)"
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build & Run on ${{ matrix.os }} / ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
          - os: ubuntu-22.04
            target: armv7-unknown-linux-gnueabihf
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-musl
          # MacOS
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}
          components: clippy

      # Cache dependencies to speed up builds
      - name: Cache Cargo Registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      # Bump version
      - name: Install Cargo Bump
        run: cargo install cargo-bump

      - name: Bump Version
        run: cargo bump ${{ github.event.inputs.version_bump }}

      # Linux build
      - name: Install Linux Toolchains
        if: startsWith(matrix.os, 'ubuntu-') && (endsWith(matrix.target, '-musl') || matrix.target == 'armv7-unknown-linux-gnueabihf')
        run: |
          sudo apt-get update
          if [ "${{ matrix.target }}" = "armv7-unknown-linux-gnueabihf" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf
          fi
          if [[ "${{ matrix.target }}" == *-musl ]]; then
            sudo apt-get install -y musl-tools
          fi

      - name: Configure musl static linking
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-musl')
        run: echo "RUSTFLAGS=-C target-feature=+crt-static" >> $GITHUB_ENV

      - name: Build (Linux)
        if: startsWith(matrix.os, 'ubuntu-')
        run: |
          if [ "${{ matrix.target }}" = "armv7-unknown-linux-gnueabihf" ]; then
            export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
          fi
          cargo build --release --verbose --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/tw tw-${{ matrix.target }}

      - name: Test (Linux)
        if: startsWith(matrix.os, 'ubuntu-') && matrix.target != 'armv7-unknown-linux-gnueabihf'
        run: cargo test --release --verbose --target ${{ matrix.target }}

      - name: Verify musl binary is static (Linux)
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-musl')
        run: |
          file tw-${{ matrix.target }}
          if ! file tw-${{ matrix.target }} | grep -Eq "statically linked|static-pie linked"; then
            echo "Expected a statically linked musl binary: tw-${{ matrix.target }}"
            exit 1
          fi

      - name: Install Cargo Deb
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-gnu')
        run: cargo install cargo-deb --version 2.11.1 --force

      - name: Generate Deb Package
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-gnu')
        run: cargo deb --no-build --no-strip --output tabiew-${{ matrix.target }}.deb --target ${{ matrix.target }}

      - name: Install Cargo RPM
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-gnu')
        run: cargo install cargo-generate-rpm --version 0.16.0 --force

      - name: Generate RPM Packages
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-gnu')
        run: cargo generate-rpm --output tabiew-${{ matrix.target }}.rpm --target ${{ matrix.target }}

      # MacOS build
      - name: Add Rust Target (MacOS)
        if: matrix.os == 'macos-latest'
        run: rustup target add ${{ matrix.target }}

      - name: Build (MacOS)
        if: matrix.os == 'macos-latest'
        run: |
          cargo build --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/tw tw-${{ matrix.target }}

      - name: Test (MacOS)
        if: matrix.os == 'macos-latest'
        run: cargo test --release --target ${{ matrix.target }}

      # Windows build
      - name: Install Windows Toolchains
        if: matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm'
        run: |
          choco install -y strawberryperl nasm
          rustup target add ${{ matrix.target }}

      - name: Build (Windows)
        if: matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm'
        run: |
          cargo build --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/tw.exe tw-${{ matrix.target }}.exe

      - name: Test (Windows)
        if: matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm'
        run: cargo test --release --target ${{ matrix.target }}

      # Upload compiled binary to GitHub artifact
      - name: Upload Binary to GitHub Artifact (Linux and MacOS)
        if: (startsWith(matrix.os, 'ubuntu-') || matrix.os == 'macos-latest') && github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tw-${{ matrix.target }}
          path: tw-${{ matrix.target }}

      - name: Upload Binary to GitHub Artifact (Windows)
        if: (matrix.os == 'windows-latest' || matrix.os == 'windows-11-arm') && github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tw-${{ matrix.target }}.exe
          path: tw-${{ matrix.target }}.exe

      # Upload Deb and RPM
      - name: Upload Deb Package to GitHub Artifact
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-gnu') && github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tabiew-${{ matrix.target }}.deb
          path: tabiew-${{ matrix.target }}.deb

      - name: Upload RPM Package to GitHub Artifact
        if: startsWith(matrix.os, 'ubuntu-') && endsWith(matrix.target, '-gnu') && github.event.inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: tabiew-${{ matrix.target }}.rpm
          path: tabiew-${{ matrix.target }}.rpm

  release:
    name: Release
    needs: build
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.dry_run != 'true' }}
    permissions:
      contents: write
    steps:
      # Bump version
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install Cargo Bump
        run: cargo install cargo-bump

      - name: Bump Version
        run: cargo bump ${{ github.event.inputs.version_bump }}

      - name: Build
        run: |
          cargo build --release

      - name: Fetch Crate Version
        run: |
          VERSION="$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')"
          echo "CRATE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "New crate version: $VERSION"

      - name: Setup Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit New Version
        run: |
          git add Cargo.*
          git commit -m "v${{ env.CRATE_VERSION }}"

      # Test cargo install locally
      - name: Test Cargo Install Locally
        run: cargo install --path .

      # Download artifacts
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: uploads/

      - name: List Compiled Artifacts
        run: ls uploads

      # Make the release
      - name: Push New Version and Create Release Tag
        run: |
          git push
          git tag "v${{ env.CRATE_VERSION }}"
          git push origin "v${{ env.CRATE_VERSION }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ env.CRATE_VERSION }}
          name: v${{ env.CRATE_VERSION }}
          draft: false
          prerelease: false
          files: |
            uploads/**

      # Publish to crates.io
      - name: Clean Up Project
        run: |
          cargo clean
          rm -rf uploads
          rm -rf .git

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CRATES_TOKEN }}
